<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
      /* Tambahkan animasi transisi untuk menu */
      #menu {
        transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
      }

      .active-nav {
        background-color: #3b82f6;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg fixed w-full z-10">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center">
          <i class="fa-solid fa-hotel mr-2"></i>Hotel POS System
        </h1>
        <button
          id="menu-toggle"
          class="block sm:hidden focus:outline-none hover:bg-blue-500 p-2 rounded transition duration-300"
          aria-label="Toggle Navigation"
        >
          â˜°
        </button>
        <!-- Menu -->
        <ul
          id="menu"
          class="hidden sm:flex absolute sm:flex-row sm:space-x-4 sm:relative top-full left-0 w-full sm:w-auto bg-blue-600 sm:bg-transparent transform -translate-y-full opacity-0 sm:translate-y-0 sm:opacity-100"
        >
          <li>
            <a
              href="index.html"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block"
              >Dashboard</a
            >
          </li>
          <li>
            <a
              href="rooms.html"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block"
              >Kamar</a
            >
          </li>
          <li>
            <a
              href="guests.html"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block"
              >Tamu</a
            >
          </li>

          <!-- Dropdown Transaksi -->
          <li class="relative">
            <button
              id="transaksi-toggle"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block active-nav"
            >
              Transaksi
            </button>
            <ul
              id="transaksi-menu"
              class="absolute left-0 w-40 bg-blue-600 hidden shadow-lg rounded mt-1"
            >
              <li>
                <a
                  href="transaksi.html"
                  class="block px-4 py-2 hover:bg-blue-500"
                  >Kamar Tamu</a
                >
              </li>
              <li>
                <a
                  href="transaksi_produk.html"
                  class="block px-4 py-2 hover:bg-blue-500"
                  >Produk</a
                >
              </li>
            </ul>
          </li>

          <li>
            <a
              href="product.html"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block"
              >Product</a
            >
          </li>
          <li>
            <a
              href="employee.html"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block"
              >Pegawai</a
            >
          </li>
          <li>
            <a
              href="login.html"
              class="hover:bg-blue-500 text-white rounded transition px-4 py-2 block"
              >Login</a
            >
          </li>
        </ul>
      </div>
    </nav>

  

       <main class="container mx-auto p-6 pt-11">
        <h2 class="text-2xl font-bold p-6 pt-12">Transaksi Produk</h2>
        <span class="pl-3"><i class="fa-solid fa-credit-card"></i></span>
      </h2>
      <div class="bg-white p-4 shadow rounded mb-4">
        <button
        id="add-transaction-btn"
        class="bg-green-600 text-white px-4 py-2 rounded"
      >
        Tambahkan Transaksi
      </button>
      </div>
      
      <div class="container mx-auto p-6">
        <div id="transactions-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>
    </main>

    <script>
      document
        .getElementById("transaksi-toggle")
        .addEventListener("click", function () {
          var menu = document.getElementById("transaksi-menu");
          menu.classList.toggle("hidden");
        });
    </script>
    <script>
      // Konfigurasi Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyB4BKM35Qy-rf0dlfqiqyWzs9AwUZq0ojA",
        authDomain: "prog4-34938.firebaseapp.com",
        projectId: "prog4-34938",
        storageBucket: "prog4-34938.appspot.com",
        messagingSenderId: "920234132726",
        appId: "1:920234132726:web:4439c637de33ddf4f3d8d7",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Ambil Data Tamu dari localStorage
      function getGuests() {
        return JSON.parse(localStorage.getItem("guests") || "[]");
      }

      // Ambil Data Kamar dari Firebase
      async function getRooms() {
        const rooms = [];
        const snapshot = await db.collection("rooms").get();
        snapshot.forEach((doc) => {
          const room = doc.data();
          rooms.push({ id: doc.id, number: room.number, type: room.type });
        });
        return rooms;
      }

      // Ambil Data Produk dari Firebase
      async function getProducts() {
        const products = [];
        const snapshot = await db.collection("product").get();
        snapshot.forEach((doc) => {
          const product = doc.data();
          products.push({
            id: doc.id,
            name: product.name,
            price: product.price,
          });
        });
        return products;
      }

  function loadTransactions() {
    const transactionList = document.getElementById("transactions-list");
    transactionList.innerHTML = "";

    db.collection("transactions").onSnapshot(snapshot => {
      transactionList.innerHTML = "";
      snapshot.forEach(doc => {
        const transaction = doc.data();
        const card = document.createElement("div");
        card.className = "bg-white p-4 shadow rounded";
        card.innerHTML = `
          <h4 class="text-lg font-bold">Tamu ID: ${transaction.guestId}</h4>
          <p>Kamar: ${transaction.roomId}</p>
          <p>Produk: ${transaction.productId}</p>
          <p>Jumlah: ${transaction.quantity}</p>
          <p class="font-bold">Total Harga: Rp ${transaction.totalPrice.toLocaleString("id-ID")}</p>
          <div class="mt-2 flex space-x-2">
            <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="editTransaction('${doc.id}', ${transaction.quantity}, ${transaction.totalPrice})">Edit</button>
            <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteTransaction('${doc.id}')">Hapus</button>
          </div>
        `;
        transactionList.appendChild(card);
      });
    });
  }

  function editTransaction(id, quantity, totalPrice) {
    Swal.fire({
      title: "Edit Transaksi",
      html: `
        <label for="quantity" class="block text-left">Jumlah:</label>
        <input type="number" id="quantity" class="swal2-input" value="${quantity}" min="1">
      `,
      showCancelButton: true,
      confirmButtonText: "Simpan",
      preConfirm: () => {
        const newQuantity = parseInt(document.getElementById("quantity").value);
        if (newQuantity <= 0) {
          Swal.showValidationMessage("Jumlah harus lebih dari 0!");
          return false;
        }
        return { newQuantity };
      }
    }).then(result => {
      if (result.isConfirmed) {
        db.collection("transactions").doc(id).update({
          quantity: result.value.newQuantity
        }).then(() => {
          Swal.fire("Berhasil!", "Transaksi berhasil diperbarui.", "success");
        }).catch(error => {
          Swal.fire("Error!", error.message, "error");
        });
      }
    });
  }

  function deleteTransaction(id) {
    Swal.fire({
      title: "Yakin ingin menghapus?",
      text: "Data transaksi ini akan dihapus secara permanen!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Ya, hapus!"
    }).then((result) => {
      if (result.isConfirmed) {
        db.collection("transactions").doc(id).delete().then(() => {
          Swal.fire("Terhapus!", "Transaksi berhasil dihapus.", "success");
        }).catch(error => {
          Swal.fire("Error!", error.message, "error");
        });
      }
    });
  }
  window.onload = loadTransactions;

      // Buka Modal Input Transaksi
      document
        .getElementById("add-transaction-btn")
        .addEventListener("click", async function () {
          const guests = getGuests();
          const rooms = await getRooms();
          const products = await getProducts();

          if (
            guests.length === 0 ||
            rooms.length === 0 ||
            products.length === 0
          ) {
            Swal.fire(
              "Error",
              "Pastikan data tamu, kamar, dan produk tersedia!",
              "error"
            );
            return;
          }

          const guestOptions = guests
            .map((g) => `<option value="${g.id}">${g.name}</option>`)
            .join("");
          const roomOptions = rooms
            .map(
              (r) => `<option value="${r.id}">${r.number} - ${r.type}</option>`
            )
            .join("");
          const productOptions = products
            .map(
              (p) =>
                `<option value="${p.id}" data-price="${p.price}">${p.name} - Rp ${p.price}</option>`
            )
            .join("");

          Swal.fire({
            title: "Tambahkan Transaksi Produk",
            html: `
                    <label for="guest-select" class="block text-left">Pilih Tamu:</label>
                    <select id="guest-select" class="swal2-input">${guestOptions}</select>

                    <label for="room-select" class="block text-left">Pilih Kamar:</label>
                    <select id="room-select" class="swal2-input">${roomOptions}</select>

                    <label for="product-select" class="block text-left">Pilih Produk:</label>
                    <select id="product-select" class="swal2-input">${productOptions}</select>

                    <label for="quantity-input" class="block text-left">Jumlah:</label>
                    <input type="number" id="quantity-input" class="swal2-input" value="1" min="1">

                    <p>Total Harga: <span id="total-price">0</span> IDR</p>
                `,
            showCancelButton: true,
            confirmButtonText: "Simpan",
            cancelButtonText: "Batal",
            didOpen: () => {
              const productSelect = document.getElementById("product-select");
              const quantityInput = document.getElementById("quantity-input");
              const totalPriceEl = document.getElementById("total-price");

              function updateTotalPrice() {
                let selectedOption =
                  productSelect.options[productSelect.selectedIndex];
                let price = parseFloat(
                  selectedOption.getAttribute("data-price") || 0
                );
                let quantity = parseInt(quantityInput.value || 1);
                totalPriceEl.textContent = (price * quantity).toLocaleString(
                  "id-ID"
                );
              }

              productSelect.addEventListener("change", updateTotalPrice);
              quantityInput.addEventListener("input", updateTotalPrice);
              updateTotalPrice();
            },
            preConfirm: () => {
              const guestId = document.getElementById("guest-select").value;
              const roomId = document.getElementById("room-select").value;
              const productId = document.getElementById("product-select").value;
              const quantity = parseInt(
                document.getElementById("quantity-input").value
              );
              const totalPrice = parseFloat(
                document
                  .getElementById("total-price")
                  .textContent.replace(/\D/g, "")
              );

              if (!guestId || !roomId || !productId || quantity <= 0) {
                Swal.showValidationMessage(
                  "Semua bidang harus diisi dengan benar!"
                );
                return false;
              }

              return { guestId, roomId, productId, quantity, totalPrice };
            },
          }).then((result) => {
            if (result.isConfirmed) {
              const { guestId, roomId, productId, quantity, totalPrice } =
                result.value;

              db.collection("transactions")
                .add({
                  guestId: guestId,
                  roomId: roomId,
                  productId: productId,
                  quantity: quantity,
                  totalPrice: totalPrice,
                  timestamp: new Date(),
                })
                .then(() => {
                  Swal.fire(
                    "Berhasil!",
                    "Transaksi berhasil disimpan.",
                    "success"
                  );
                })
                .catch((error) => {
                  Swal.fire("Error!", error.message, "error");
                });
            }
          });
        });
    </script>
  </body>
</html>
